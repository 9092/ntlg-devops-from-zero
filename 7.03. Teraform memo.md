## Подготовка ЯО

> **Note**
> Вся фигня тут: https://cloud.yandex.ru/docs/tutorials/infrastructure-management/terraform-quickstart#install-terraform

### Создание сервисного аккаунта в ЯО
- Создаем в своем облаке ЯО каталог hw-7-03
- Ставим ЯО CLI для Linux: `curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash`
- Проверяем, прописалась ли переменная окружения, выполнив `yc`. Если вылезла ошибка, что файл не найден, добавляем значение а PATH:
```
export PATH=$PATH:/home/**igor**/yandex-cloud/bin
```
> **Note**
> Идея в том, что `yc` должна выполняться без указания полного пути к ней

- Получаем OAuth token в ЯО и сохраняем его в менеджер паролей: https://cloud.yandex.com/en/docs/iam/concepts/authorization/oauth-token
- Выполните команду `yc init` для настройки профиля CLI: https://cloud.yandex.ru/docs/cli/quickstart#install

- Создаем сервисный аккаунт:
```yc iam service-account --folder-name hw-7-03 create --name svc-terform```

- Получаем `$ID` сервисного аккаунта для следующей команды назначения прав:

```yc iam service-account --folder-name hw-7-03 list```

- Выдаем ему права `admin`:

```yc resource-manager folder add-access-binding hw-7-03 --role admin --subject serviceAccount:$ID```

- Создайте авторизованный ключ для сервисного аккаунта и запишите его файл:

```yc iam key create --service-account-id $ID --folder-name hw-7-03 --output key.json```

- Создайте профиль CLI для выполнения операций от имени сервисного аккаунта:

```yc config profile create svc-terform```

- Задайте конфигурацию профиля:

`yc config set cloud-id <идентификатор_облака>` - <идентификатор_облака> берем из веб-морды управления ЯО

`yc config set folder-id <идентификатор_каталога>`  - <идентификатор_каталога> берем из веб-морды управления ЯО

`yc config set service-account-key key.json`

- Добавьте аутентификационные данные в переменные окружения:
```
export YC_TOKEN=$(yc iam create-token)
export YC_CLOUD_ID=$(yc config get cloud-id)
export YC_FOLDER_ID=$(yc config get folder-id)
```
> **Note**
> Если все сделано правильно, то по идее подготовка ЯО завершена.

## Ставим terraform на Ubuntu
```
sudo apt update && \
sudo apt install -y gnupg software-properties-common curl && \
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add - && \
sudo apt-add-repository -y "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main" && \
sudo apt update && sudo apt install -y terraform
```
### Создайте файл конфигурации Terraform
- Создаем папку для файла с конфигурацией терраформ: `mkdir -p ~/terraform/yac`
- Настраиваем провайдер:
```
mv ~/.terraformrc ~/.terraformrc.old
nano ~/.terraformrc
```

- Файл `~/.terraformrc` наполняем следующим содержимым (настройка зеркала Яндекса для провайдеров terraform, так как доступ из РФ все):
```
provider_installation {
  network_mirror {
    url = "https://terraform-mirror.yandexcloud.net/"
    include = ["registry.terraform.io/*/*"]
  }
  direct {
    exclude = ["registry.terraform.io/*/*"]
  }
}
```

- Создаем файл для будущей конфигурации: `nano ~/terraform/yac/yac-main.tf`
- Наполняем его:

```
terraform {
  required_providers {
    yandex = {
      source = "yandex-cloud/yandex"
    }
  }
  required_version = ">= 0.13"
}

provider "yandex" {
  zone = "ru-central1-a"
}
```
- Выполните команду `terraform init` в папке с конфигурационным файлом .tf

- Добавляем описание инфраструктуры в ЯО в файл `~/terraform/yac/yac-main.tf`. В итоге содержание файла будет таким:
```
terraform {
  required_providers {
    yandex = {
      source = "yandex-cloud/yandex"
    }
  }
  required_version = ">= 0.13"
}

provider "yandex" {
  zone = "ru-central1-a"
}

resource "yandex_compute_instance" "vm-1" {
  name = "terraform1"

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = "fd864gbboths76r8gm5f"
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.subnet-1.id
    nat       = true
  }

  metadata = {
    ssh-keys = "ubuntu:${file("~/.ssh/id_ed25519.pub")}"
    #user-data = "${file("/home/igor/terraform/yac/users_metadata")}"
  }
}

resource "yandex_compute_instance" "vm-2" {
  name = "terraform2"

  resources {
    cores  = 2
    memory = 2
  }

  boot_disk {
    initialize_params {
      image_id = "fd864gbboths76r8gm5f"
    }
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.subnet-1.id
    nat       = true
  }

  metadata = {
    ssh-keys = "ubuntu:${file("~/.ssh/id_ed25519.pub")}"
    #user-data = "${file("/home/igor/terraform/yac/users_metadata")}"
  }
}

resource "yandex_vpc_network" "network-1" {
  name = "network1"
}

resource "yandex_vpc_subnet" "subnet-1" {
  name           = "subnet1"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.network-1.id
  v4_cidr_blocks = ["192.168.10.0/24"]
}

output "internal_ip_address_vm_1" {
  value = yandex_compute_instance.vm-1.network_interface.0.ip_address
}

output "internal_ip_address_vm_2" {
  value = yandex_compute_instance.vm-2.network_interface.0.ip_address
}


output "external_ip_address_vm_1" {
  value = yandex_compute_instance.vm-1.network_interface.0.nat_ip_address
}

output "external_ip_address_vm_2" {
  value = yandex_compute_instance.vm-2.network_interface.0.nat_ip_address
}
```

### Проверьте и отформатируйте файлы конфигураций
- Проверьте конфигурацию командой: `terraform validate`
- Если конфигурация является допустимой, появится сообщение: `Success! The configuration is valid.`
- Отформатируйте файлы конфигураций в текущем каталоге и подкаталогах: `terraform fmt`
### Создаем ресурсы в ЯО
- После проверки конфигурации выполните команду: `terraform plan`
- Чтобы создать ресурсы выполните команду: `terraform apply`

### Удаляем ресурсы в ЯО
Чтобы удалить ресурсы, созданные с помощью Terraform выполните команду: `terraform destroy`